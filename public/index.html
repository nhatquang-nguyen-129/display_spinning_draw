<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üéØ Quay s·ªë may m·∫Øn üéØ</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* üé• Video n·ªÅn */
    #bg-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -3;
      opacity: 0.85;
    }

    /* üåë L·ªõp overlay l√†m t·ªëi video */
    #video-dim {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      opacity: 0.35;
      z-index: -2;
      transition: opacity 1.2s ease-in-out;
    }

    #fireworks-container {
      position: fixed;
      inset: 0;
      z-index: -2;
      pointer-events: none;
    }

    .flip-container {
      display: flex;
      gap: 16px;
      justify-content: center;
      align-items: center;
      margin-bottom: 40px;
    }

    .digit-box {
      width: 189px;
      height: 253px;
      background: #fff;
      color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10.56rem;
      font-weight: 900;
      border-radius: 14px;
      box-shadow: 0 6px 22px rgba(0,0,0,0.5);
      position: relative;
      overflow: hidden;
    }

    .digit-inner { position: absolute; inset: 0; overflow: hidden; }

    .digit-item {
      position: absolute;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translateY(0);
    }

    @keyframes bounce {
      0% { transform: translateY(0); }
      30% { transform: translateY(-15%); }
      60% { transform: translateY(5%); }
      100% { transform: translateY(0); }
    }
    .bounce { animation: bounce 0.4s ease-out; }

    /* üéâ Ph·∫ßn hi·ªÉn th·ªã ng∆∞·ªùi tr√∫ng th∆∞·ªüng */
    .winner {
      text-align: center;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .winner .line1 {
      font-size: 3.0rem;
      font-weight: 700;
      color: #ff9933;
      text-shadow: 0 0 16px #000;
      margin-bottom: 10px;
    }

    .winner .line2 {
      font-size: 4.0rem;
      font-weight: 900;
      color: #00ffcc;
      text-shadow: 0 0 16px #000;
    }

    .winner span {
      opacity: 0;
      transform: translateY(20px);
      display: inline-block;
      transition: opacity 0.6s ease, transform 0.6s ease;
    }

    .note {
      margin-top: 6px;
      font-size: 3rem;
      opacity: 1.0;
      color: #ccc;
    }

    button {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      padding: 12px 34px;
      border-radius: 11px;
      border: none;
      background: #ff6600;
      color: white;
      cursor: pointer;
      transition: 0.3s ease;
      display: inline-block;
      width: auto;
    }

    button:hover:not(:disabled) {
      background: #ff7f2a;
      transform: translateX(-50%) scale(1.08);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <video id="bg-video" muted playsinline>
    <source src="background.mp4" type="video/mp4">
  </video>

  <div id="video-dim"></div>
  <canvas id="fireworks-container"></canvas>

  <div class="flip-container">
    <div class="digit-box"><div class="digit-inner" id="inner1"><div class="digit-item">-</div></div></div>
    <div class="digit-box"><div class="digit-inner" id="inner2"><div class="digit-item">-</div></div></div>
    <div class="digit-box"><div class="digit-inner" id="inner3"><div class="digit-item">-</div></div></div>
  </div>

  <div id="winner" class="winner">
    <div class="line1">
      <span id="part1">üéâ Ch√∫c m·ª´ng M·∫π üéâ</span>
    </div>
    <div class="line2">
      <span id="part2" class="highlight-name"></span>
    </div>
  </div>

  <div id="note" class="note"></div>

  <button id="spinBtn" onclick="spin()">B·∫ÆT ƒê·∫¶U QUAY</button>

  <script>
    let fireworksAnimationId = null;
    let fireworks = [];
    let particles = [];

    function showFireworks() {
      const canvas = document.getElementById("fireworks-container");
      const ctx = canvas.getContext("2d");
      const W = canvas.width = window.innerWidth;
      const H = canvas.height = window.innerHeight;

      function random(min, max) {
        return Math.random() * (max - min) + min;
      }

      function createFirework() {
        const x = random(W * 0.2, W * 0.8);
        const y = random(H * 0.2, H * 0.5);
        const colors = ["#ff4b1f", "#1affd5", "#ffff66", "#ff00ff", "#00ffff"];
        const color = colors[Math.floor(random(0, colors.length))];
        for (let i = 0; i < 50; i++) {
          particles.push({
            x,
            y,
            vx: random(-5, 5),
            vy: random(-5, 5),
            life: random(40, 100),
            color,
          });
        }
      }

      particles = [];
      for (let i = 0; i < 6; i++) createFirework();

      cancelAnimationFrame(fireworksAnimationId);

      function animate() {
        ctx.fillStyle = "rgba(0,0,0,0.15)";
        ctx.fillRect(0, 0, W, H);
        particles.forEach((p, i) => {
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.1; // gravity
          p.life--;
          ctx.beginPath();
          ctx.fillStyle = p.color;
          ctx.arc(p.x, p.y, 2, 0, 2 * Math.PI);
          ctx.fill();
          if (p.life <= 0) particles.splice(i, 1);
        });
        if (particles.length > 0) fireworksAnimationId = requestAnimationFrame(animate);
      }

      animate();
    }

    async function slideOnce(innerEl, nextNum, durationMs = 80) {
      return new Promise(resolve => {
        const curr = innerEl.querySelector('.digit-item');
        const next = document.createElement('div');
        next.className = 'digit-item';
        next.textContent = nextNum;
        next.style.transform = 'translateY(-100%)';
        const ms = Math.max(40, Math.min(400, Math.round(durationMs)));
        curr.style.transition = `transform ${ms}ms linear`;
        next.style.transition = `transform ${ms}ms linear`;
        innerEl.appendChild(next);
        next.getBoundingClientRect();
        requestAnimationFrame(() => {
          curr.style.transform = 'translateY(100%)';
          next.style.transform = 'translateY(0)';
        });
        const cleanup = () => {
          innerEl.removeChild(curr);
          next.style.transition='';
          next.style.transform='';
          resolve(next);
        };
        next.addEventListener('transitionend', cleanup, { once: true });
        setTimeout(cleanup, ms + 50);
      });
    }

    async function rollDigitSliding(innerEl, finalNum, totalDuration = 3000) {
      const initialDelay = 20;
      const maxDelay = 280;
      const steps = Math.max(8, Math.floor(totalDuration / 80));
      for (let i = 0; i < steps; i++) {
        const progress = i / Math.max(1, steps - 1);
        const eased = 1 / (1 + Math.exp(-10 * (progress - 0.8)));
        const delay = initialDelay + eased * (maxDelay - initialDelay);
        const rnd = Math.floor(Math.random() * 10);
        await slideOnce(innerEl, rnd, delay);
      }
      const finalEl = await slideOnce(innerEl, finalNum, Math.min(maxDelay, 450));
      finalEl.classList.add('bounce');
      setTimeout(()=>finalEl.classList.remove('bounce'),500);
    }

    async function getSpinData() {
      try {
        const resp = await fetch('/spin');
        const data = await resp.json();
        return data;
      } catch(err) {
        console.error("L·ªói l·∫•y d·ªØ li·ªáu spin:", err);
        return { stt: 999, hoTen: "Nguy·ªÖn Th·ªã Lan", baSoCuoi: "123" };
      }
    }

    async function spin() {
      const btn = document.getElementById('spinBtn');
      const winnerDiv = document.getElementById('winner');
      const noteDiv = document.getElementById('note');
      const innerEls = [
        document.getElementById('inner1'),
        document.getElementById('inner2'),
        document.getElementById('inner3')
      ];
      const dim = document.getElementById('video-dim');
      const video = document.getElementById('bg-video');
      const canvas = document.getElementById("fireworks-container");
      const ctx = canvas.getContext("2d");

      dim.style.opacity = 0.25;
      if (fireworksAnimationId) cancelAnimationFrame(fireworksAnimationId);
      fireworks = [];
      particles = [];
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      video.currentTime = 0;
      video.play();

      ['part1','part2'].forEach(id=>{
        const el=document.getElementById(id);
        el.style.opacity=0;
        el.style.transform='translateY(20px)';
      });
      noteDiv.style.opacity=0;
      noteDiv.innerText='';

      btn.disabled=true;
      btn.innerText='üé≤ ƒêANG QUAY...';
      winnerDiv.style.opacity=1;
      innerEls.forEach(e=>e.innerHTML=`<div class="digit-item">-</div>`);

      const data = await getSpinData();
      const { stt, hoTen, baSoCuoi } = data;
      const arr = baSoCuoi.split('').map(c => c || '0');

      const digitDurations = [800, 2400, 3800];

      for(let i=0;i<arr.length;i++){
        await rollDigitSliding(innerEls[i], arr[i], digitDurations[i]);
      }

      dim.style.opacity = 0.85;

      setTimeout(() => {
        showFireworks();
        const part1 = document.getElementById('part1');
        const part2 = document.getElementById('part2');

        part1.style.opacity = 1;
        part1.style.transform = 'translateY(0)';

        setTimeout(() => {
          part2.textContent = hoTen;
          part2.style.opacity = 1;
          part2.style.transform = 'translateY(0)';

          noteDiv.innerText = `(S·ªë th·ª© t·ª±: ${stt})`;
          noteDiv.style.opacity = 0.95;
        }, 600);

      }, 1000);

      btn.disabled=false;
      btn.innerText='QUAY L·∫†I';
    }

    // üîπ B·∫•m ph√≠m Enter ƒë·ªÉ trigger quay
    document.addEventListener('keydown', function(event) {
      if (event.key === "Enter") {
        const btn = document.getElementById('spinBtn');
        if (!btn.disabled) {
          btn.click();
        }
      }
    });
  </script>
</body>
</html>