<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üéØ Quay s·ªë may m·∫Øn üéØ</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    #bg-video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -3;
      opacity: 0.4;
    }

    #fireworks-container {
      position: fixed;
      inset: 0;
      z-index: -2;
      pointer-events: none;
    }

    h1 {
      font-size: 3.0rem;
      color: #ffcc00;
      letter-spacing: 2px;
      text-shadow: 0 0 8px #000;
      margin: 0;
      margin-bottom: 40px;
    }

    .flip-container {
      display: flex;
      gap: 16px;
      justify-content: center;
      align-items: center;
      margin-bottom: 40px;
    }

    .digit-box {
      width: 144px;
      height: 192px;
      background: #fff;
      color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 8.0rem;
      font-weight: 900;
      border-radius: 14px;
      box-shadow: 0 6px 22px rgba(0,0,0,0.5);
      position: relative;
      overflow: hidden;
    }

    .digit-inner { position: absolute; inset: 0; overflow: hidden; }

    .digit-item {
      position: absolute;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translateY(0);
    }

    @keyframes bounce {
      0% { transform: translateY(0); }
      30% { transform: translateY(-15%); }
      60% { transform: translateY(5%); }
      100% { transform: translateY(0); }
    }

    .bounce { animation: bounce 0.4s ease-out; }

    .winner {
      font-size: 3.0rem;
      font-weight: 700;
      color: #ff6600;
      text-shadow: 0 0 12px #000;
      display: flex;
      justify-content: center;
      align-items: baseline;
      flex-wrap: wrap;
      margin-bottom: 60px;
    }

    .winner span {
      opacity: 0;
      transform: translateY(20px);
      display: inline-block;
      transition: opacity 0.6s ease, transform 0.6s ease, font-size 0.3s ease;
      font-size: inherit;
      margin: 0 6px;
    }

    .winner .highlight-name {
      color: #00ffcc;
      font-size: 4.0rem;
      font-weight: 900;
    }

    .note {
      margin-top: 12px;
      font-size: 1.5rem;
      opacity: 1.0;
      color: #ccc;
    }

    button {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      padding: 12px 34px;
      border-radius: 11px;
      border: none;
      background: #ff6600;
      color: white;
      cursor: pointer;
      transition: 0.3s ease;
      display: inline-block;
      width: auto;
    }

    button:hover:not(:disabled) {
      background: #ff7f2a;
      transform: translateX(-50%) scale(1.08);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <video id="bg-video" autoplay muted loop playsinline>
    <source src="background.mp4" type="video/mp4">
  </video>

  <canvas id="fireworks-container"></canvas>

  <h1>üéØ V√íNG QUAY SƒêT MAY M·∫ÆN üéØ</h1>

  <div class="flip-container">
    <div class="digit-box"><div class="digit-inner" id="inner1"><div class="digit-item">-</div></div></div>
    <div class="digit-box"><div class="digit-inner" id="inner2"><div class="digit-item">-</div></div></div>
    <div class="digit-box"><div class="digit-inner" id="inner3"><div class="digit-item">-</div></div></div>
  </div>

  <div id="winner" class="winner">
    <span id="part1">üéâ Ch√∫c m·ª´ng M·∫π </span>
    <span id="part2" class="highlight-name"></span>
    <span id="part3"> ƒë√£ tr√∫ng th∆∞·ªüng! üéâ</span>
  </div>

  <div id="note" class="note"></div>

  <button id="spinBtn" onclick="spin()">B·∫ÆT ƒê·∫¶U QUAY</button>

  <script>
    // ======== PH√ÅO HOA ========
    let fireworksAnimationId; // <-- bi·∫øn to√†n c·ª•c ƒë·ªÉ d·ª´ng animation
    let fireworks = [];
    let particles = [];

    function showFireworks(durationMs = 10000) {
      const canvas = document.getElementById("fireworks-container");
      const ctx = canvas.getContext("2d");
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const colors = ["#ff00ff","#ffd700","#00ffff","#ff4500","#7fffd4","#ffffff","#ff1493","#ffa500"];
      const endTime = Date.now() + durationMs;

      function spawnFirework(extra=false) {
        const startX = canvas.width / 2 + (Math.random() - 0.5) * 400;
        const startY = canvas.height + 10;
        const side = Math.random() < 0.5 ? 1 : -1;
        const angle = Math.PI / 2 + side * (Math.random() * Math.PI / 4);
        const speed = 14 + Math.random() * 3 + (extra ? 4 : 0);
        const color = colors[Math.floor(Math.random() * colors.length)];
        fireworks.push({ x: startX, y: startY, vx: Math.cos(angle) * speed, vy: -Math.abs(Math.sin(angle) * speed), color, exploded: false, alpha: 1, tail: [] });
      }

      function explode(x, y, color) {
        const numParticles = 35 + Math.floor(Math.random() * 15);
        for (let i = 0; i < numParticles; i++) {
          const angle = (i / numParticles) * 2 * Math.PI;
          const speed = 2 + Math.random() * 3;
          particles.push({ x, y, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, color, alpha: 1, life: 80 + Math.random() * 40, radius: 1.5 + Math.random() * 1.5 });
        }
      }

      function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        fireworks.forEach(f => {
          f.tail.push({ x: f.x, y: f.y });
          if (f.tail.length > 5) f.tail.shift();
          f.x += f.vx; f.y += f.vy; f.vy += 0.15; f.alpha -= 0.0045;

          ctx.globalCompositeOperation = "lighter";
          ctx.strokeStyle = f.color; ctx.lineWidth = 2; ctx.beginPath();
          for (let i = 0; i < f.tail.length - 1; i++) {
            ctx.globalAlpha = i / f.tail.length;
            ctx.moveTo(f.tail[i].x, f.tail[i].y); ctx.lineTo(f.tail[i + 1].x, f.tail[i + 1].y);
          }
          ctx.stroke();

          ctx.globalAlpha = f.alpha; ctx.fillStyle = f.color; ctx.shadowBlur = 6; ctx.shadowColor = f.color;
          ctx.beginPath(); ctx.arc(f.x, f.y, 4, 0, 2 * Math.PI); ctx.fill();
          ctx.shadowBlur = 0; ctx.globalCompositeOperation = "source-over";

          if (f.vy >= 0 && !f.exploded) { f.exploded = true; explode(f.x, f.y, f.color); }
        });

        for (let i = fireworks.length - 1; i >= 0; i--) {
          if (fireworks[i].exploded || fireworks[i].alpha <= 0) fireworks.splice(i, 1);
        }

        particles.forEach(p => {
          p.x += p.vx; p.y += p.vy; p.vy += 0.07; p.alpha -= 0.013; p.life -= 1;
          ctx.globalCompositeOperation = "lighter"; ctx.globalAlpha = Math.max(p.alpha, 0); ctx.fillStyle = p.color;
          ctx.shadowBlur = 4; ctx.shadowColor = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.radius, 0, 2 * Math.PI); ctx.fill();
          ctx.shadowBlur = 0; ctx.globalCompositeOperation = "source-over";
        });

        for (let i = particles.length - 1; i >= 0; i--) {
          if (particles[i].alpha <= 0 || particles[i].life <= 0) particles.splice(i, 1);
        }

        if (Date.now() < endTime || particles.length > 0 || fireworks.length > 0) {
          if (Date.now() < endTime && Math.random() < 0.04) {
            const burstCount = 3 + Math.floor(Math.random() * 2);
            for (let i = 0; i < burstCount; i++) spawnFirework();
            if (Math.random() < 0.3) spawnFirework(true);
          }
          fireworksAnimationId = requestAnimationFrame(animate);
        }
      }

      animate();
    }

    // ======== SLIDE S·ªê & HI·ªÇN TH·ªä WINNER ========
    async function slideOnce(innerEl, nextNum, durationMs = 80) {
      return new Promise(resolve => {
        const curr = innerEl.querySelector('.digit-item');
        const next = document.createElement('div');
        next.className = 'digit-item'; next.textContent = nextNum; next.style.transform = 'translateY(-100%)';
        const ms = Math.max(40, Math.min(400, Math.round(durationMs)));
        curr.style.transition = `transform ${ms}ms linear`; next.style.transition = `transform ${ms}ms linear`;
        innerEl.appendChild(next); next.getBoundingClientRect();
        requestAnimationFrame(() => { curr.style.transform = 'translateY(100%)'; next.style.transform = 'translateY(0)'; });
        const cleanup = () => { innerEl.removeChild(curr); next.style.transition=''; next.style.transform=''; resolve(next); };
        next.addEventListener('transitionend', cleanup, { once: true });
        setTimeout(cleanup, ms + 50);
      });
    }

    async function rollDigitSliding(innerEl, finalNum, totalDuration = 3000) {
      const initialDelay = 20; const maxDelay = 280;
      const steps = Math.max(8, Math.floor(totalDuration / 80));
      for (let i = 0; i < steps; i++){
        const progress = i / Math.max(1, steps - 1);
        const eased = 1 / (1 + Math.exp(-10 * (progress - 0.8)));
        const delay = initialDelay + eased * (maxDelay - initialDelay);
        const rnd = Math.floor(Math.random() * 10);
        await slideOnce(innerEl, rnd, delay);
      }
      const finalEl = await slideOnce(innerEl, finalNum, Math.min(maxDelay, 450));
      finalEl.classList.add('bounce');
      setTimeout(()=>finalEl.classList.remove('bounce'),500);
    }

    // ======== G·ªåI API SERVER /spin ========
    async function getSpinData() {
      try {
        const resp = await fetch('/spin');
        const data = await resp.json();
        return data;
      } catch(err) {
        console.error("L·ªói l·∫•y d·ªØ li·ªáu spin:", err);
        return { stt: 999, hoTen: "Nguy·ªÖn Th·ªã Lan", baSoCuoi: "123" };
      }
    }

    async function spin() {
      const btn = document.getElementById('spinBtn');
      const winnerDiv = document.getElementById('winner');
      const noteDiv = document.getElementById('note');
      const innerEls = [document.getElementById('inner1'), document.getElementById('inner2'), document.getElementById('inner3')];
      const video = document.getElementById('bg-video');
      const canvas = document.getElementById("fireworks-container");
      const ctx = canvas.getContext("2d");

      // --- D·ª™NG NGAY PH√ÅO HOA N·∫æU ƒêANG CH·∫†Y ---
      if (fireworksAnimationId) cancelAnimationFrame(fireworksAnimationId);
      fireworks = [];
      particles = [];
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // --- reset video v·ªÅ ƒë·∫ßu ---
      video.currentTime = 0;
      video.play();

      // --- reset hi·ªÉn th·ªã ---
      ['part1','part2','part3'].forEach(id=>{
        const el=document.getElementById(id);
        el.style.opacity=0; el.style.transform='translateY(20px)';
      });
      noteDiv.style.opacity=0; noteDiv.innerText='';

      btn.disabled=true; btn.innerText='üé≤ ƒêANG QUAY...';
      winnerDiv.style.opacity=1;
      innerEls.forEach(e=>e.innerHTML=`<div class="digit-item">-</div>`);

      const data = await getSpinData();
      const { stt, hoTen, baSoCuoi } = data;
      const arr = baSoCuoi.split('').map(c => c || '0');

      for(let i=0;i<arr.length;i++){
        await rollDigitSliding(innerEls[i], arr[i], 2500+i*400);
      }

      setTimeout(()=>{
        showFireworks();
        const part1=document.getElementById('part1');
        const part2=document.getElementById('part2');
        const part3=document.getElementById('part3');

        part1.style.opacity = 1; part1.style.transform = 'translateY(0)';
        setTimeout(()=>{ part2.textContent = hoTen; part2.style.opacity = 1; part2.style.transform = 'translateY(0)'; }, 500);
        setTimeout(()=>{ part3.style.opacity = 1; part3.style.transform = 'translateY(0)'; }, 1000);

        noteDiv.innerText=`(STT: ${stt})`; noteDiv.style.opacity=0.9;
      },1000);

      btn.disabled=false; btn.innerText='QUAY L·∫†I';
    }
  </script>
</body>
</html>
