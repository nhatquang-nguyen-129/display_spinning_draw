<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>üéØ Quay s·ªë may m·∫Øn üéØ</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #000;
      color: #fff;
      overflow: hidden;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    /* üñºÔ∏è H√¨nh n·ªÅn */
    #bg-image {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -3;
      opacity: 1;
      animation: sway 10s ease-in-out infinite;
      will-change: transform;
    }

    @keyframes sway {
      0% { transform: scale(1.02) translateY(0px) rotate(0deg); filter: brightness(1); }
      25% { transform: scale(1.025) translateY(-4px) rotate(0.2deg); filter: brightness(1.02); }
      50% { transform: scale(1.03) translateY(2px) rotate(-0.2deg); filter: brightness(1.03); }
      75% { transform: scale(1.025) translateY(-3px) rotate(0.15deg); filter: brightness(1.02); }
      100% { transform: scale(1.02) translateY(0px) rotate(0deg); filter: brightness(1); }
    }

    #video-dim {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      opacity: 0;
      z-index: -2;
      transition: opacity 1.2s ease-in-out;
    }

    #fireworks-container {
      position: fixed;
      inset: 0;
      z-index: -2;
      pointer-events: none;
    }

    .flip-container {
      display: flex;
      gap: 16px;
      justify-content: center;
      align-items: center;
      margin-bottom: 40px;
    }

    .digit-box {
      width: 189px;
      height: 253px;
      background: #fff;
      color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 10.56rem;
      font-weight: 900;
      border-radius: 14px;
      box-shadow: 0 6px 22px rgba(0,0,0,0.5);
      position: relative;
      overflow: hidden;
    }

    .digit-inner { position: absolute; inset: 0; overflow: hidden; }

    .digit-item {
      position: absolute;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translateY(0);
    }

    @keyframes bounce {
      0% { transform: translateY(0); }
      30% { transform: translateY(-15%); }
      60% { transform: translateY(5%); }
      100% { transform: translateY(0); }
    }
    .bounce { animation: bounce 0.4s ease-out; }

    .winner {
      text-align: center;
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .winner .line1 {
      font-size: 4rem;
      font-weight: 700;
      color: #ff9933;
      text-shadow: 0 0 16px #000;
      margin-bottom: 10px;
    }

    .winner .line2 {
      font-size: 6rem;
      font-weight: 900;
      color: #00ffcc;
      text-shadow: 0 0 16px #000;
    }

    .winner span {
      opacity: 0;
      transform: translateY(20px);
      display: inline-block;
      transition: opacity 0.6s ease, transform 0.6s ease;
    }

    .note {
      margin-top: 6px;
      font-size: 3rem;
      opacity: 1;
      color: #ccc;
    }

    button {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      padding: 12px 34px;
      border-radius: 11px;
      border: none;
      background: #ff6600;
      color: white;
      cursor: pointer;
      transition: 0.3s ease;
      display: inline-block;
    }

    button:hover:not(:disabled) {
      background: #ff7f2a;
      transform: translateX(-50%) scale(1.08);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #logo {
      position: fixed;
      top: 24px;
      left: 24px;
      width: 200px;
      z-index: 1000;
      pointer-events: none;
      filter: drop-shadow(0 0 6px rgba(255,255,255,0.5));
      overflow: hidden;
    }
  </style>
</head>
<body>
  <img id="bg-image" src="background.jpg" alt="background">
  <div id="video-dim"></div>
  <canvas id="fireworks-container"></canvas>

  <div id="logo">
    <img src="logo.png" alt="Logo" style="width:100%;height:auto;">
  </div>

  <div class="flip-container">
    <div class="digit-box"><div class="digit-inner" id="inner1"><div class="digit-item">-</div></div></div>
    <div class="digit-box"><div class="digit-inner" id="inner2"><div class="digit-item">-</div></div></div>
    <div class="digit-box"><div class="digit-inner" id="inner3"><div class="digit-item">-</div></div></div>
  </div>

  <div id="winner" class="winner">
    <div class="line1"><span id="part1">üéâ Ch√∫c m·ª´ng M·∫π üéâ</span></div>
    <div class="line2"><span id="part2" class="highlight-name"></span></div>
  </div>

  <div id="note" class="note"></div>
  <button id="spinBtn" onclick="spin()">B·∫ÆT ƒê·∫¶U QUAY</button>

  <script>
    let fireworksAnimationId = null;

      /* Code ƒëi·ªÅu khi·ªÉn ph√°o hoa */
      function showFireworks() {
        const canvas = document.getElementById("fireworks-container");
        const ctx = canvas.getContext("2d");
        const W = (canvas.width = window.innerWidth);
        const H = (canvas.height = window.innerHeight);

        const colors = ["#ff4b1f", "#ffcc00", "#00ffff", "#ff00ff", "#ffffff"];
        let rockets = [];
        let particles = [];

        function random(min, max) {
          return Math.random() * (max - min) + min;
        }

        function launchRockets() {
          // üö´ Gi·ªõi h·∫°n t·ªïng rocket tr√™n m√†n h√¨nh t·ªëi ƒëa 4
          if (rockets.length >= 4) return;

          for (let i = 0; i < random(1, 2); i++) { // üëà b·∫Øn 1‚Äì2 rocket m·ªói ƒë·ª£t
            rockets.push({
              x: (() => {
                let x;
                do {
                  x = random(W * 0.15, W * 0.85);
                } while (x > W * 0.4 && x < W * 0.6); // tr√°nh v√πng Winner
                return x;
              })(),
              y: H,
              vx: random(-0.8, 0.8),
              vy: random(-12, -15),
              targetHeight: random(H * 0.20, H * 0.32),
              color: colors[Math.floor(Math.random() * colors.length)],
              exploded: false,
            });
          }
        }

        const startTime = performance.now();
        function launchLoop(time) {
          if (time - startTime < 10000) {
            launchRockets();
            setTimeout(() => requestAnimationFrame(launchLoop), random(900, 1200));
          }
        }
        requestAnimationFrame(launchLoop);

        function explode(rocket) {
          const count = 50 + Math.floor(Math.random() * 40); // üëà gi·∫£m c√≤n ~2/3
          for (let i = 0; i < count; i++) {
            const angle = Math.random() * 2 * Math.PI;
            const speed = Math.random() * 2.6 + 0.6;
            particles.push({
              x: rocket.x,
              y: rocket.y,
              vx: Math.cos(angle) * speed,
              vy: Math.sin(angle) * speed,
              gravity: 0.015,
              alpha: 1,
              fade: 0.002 + Math.random() * 0.0015,
              color: rocket.color,
              size: random(1.2, 2.4),
              life: random(320, 460),
            });
          }
        }

        function animate() {
          ctx.fillStyle = "rgba(0,0,0,0.12)";
          ctx.fillRect(0, 0, W, H);

          // üöÄ Rockets bay l√™n
          for (let i = rockets.length - 1; i >= 0; i--) {
            const r = rockets[i];
            r.x += r.vx;
            r.y += r.vy;
            r.vy += 0.12;

            ctx.beginPath();
            ctx.fillStyle = r.color;
            ctx.arc(r.x, r.y, 2.5, 0, Math.PI * 2);
            ctx.fill();

            const grad = ctx.createLinearGradient(r.x, r.y, r.x, r.y + 20);
            grad.addColorStop(0, r.color);
            grad.addColorStop(1, "rgba(0,0,0,0)");
            ctx.fillStyle = grad;
            ctx.fillRect(r.x - 1, r.y, 2, 20);

            // üéØ N·ªï ƒë√∫ng v√πng targetHeight ho·∫∑c khi b·∫Øt ƒë·∫ßu r∆°i xu·ªëng
            if (!r.exploded && (r.y <= r.targetHeight || r.vy >= 0)) {
              explode(r);
              r.exploded = true;
              rockets.splice(i, 1);
            }

            if (r.y > H || r.x < 0 || r.x > W) rockets.splice(i, 1);
          }

          // üå† Particles sau khi n·ªï
          for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vy += p.gravity;
            p.alpha -= p.fade;
            p.life--;

            // Glow t·ªëi gi·∫£n
            ctx.beginPath();
            ctx.fillStyle = `${p.color}${Math.floor(p.alpha * 200)
              .toString(16)
              .padStart(2, "0")}`;
            ctx.arc(p.x, p.y, p.size * 1.5, 0, Math.PI * 2);
            ctx.fill();

            // ƒêu√¥i s√°ng m·ªÅm
            ctx.beginPath();
            ctx.strokeStyle = `${p.color}${Math.floor(p.alpha * 180)
              .toString(16)
              .padStart(2, "0")}`;
            ctx.lineWidth = 1;
            ctx.moveTo(p.x, p.y);
            ctx.lineTo(p.x - p.vx * 3, p.y - p.vy * 3);
            ctx.stroke();

            if (p.life <= 0 || p.alpha <= 0) particles.splice(i, 1);
          }

          if (
            performance.now() - startTime < 11500 ||
            rockets.length > 0 ||
            particles.length > 0
          ) {
            fireworksAnimationId = requestAnimationFrame(animate);
          } else {
            cancelAnimationFrame(fireworksAnimationId);
          }
        }

        fireworksAnimationId = requestAnimationFrame(animate);
      }

    /* --- Logic quay s·ªë --- */
    async function slideOnce(innerEl, nextNum, durationMs = 80) {
      return new Promise(resolve => {
        const curr = innerEl.querySelector('.digit-item');
        const next = document.createElement('div');
        next.className = 'digit-item';
        next.textContent = nextNum;
        next.style.transform = 'translateY(-100%)';
        const ms = Math.max(40, Math.min(400, Math.round(durationMs)));
        curr.style.transition = `transform ${ms}ms linear`;
        next.style.transition = `transform ${ms}ms linear`;
        innerEl.appendChild(next);
        next.getBoundingClientRect();
        requestAnimationFrame(() => {
          curr.style.transform = 'translateY(100%)';
          next.style.transform = 'translateY(0)';
        });
        const cleanup = () => {
          innerEl.removeChild(curr);
          next.style.transition='';
          next.style.transform='';
          resolve(next);
        };
        next.addEventListener('transitionend', cleanup, { once: true });
        setTimeout(cleanup, ms + 50);
      });
    }

    async function rollDigitSliding(innerEl, finalNum, totalDuration = 3000) {
      const initialDelay = 20, maxDelay = 280;
      const steps = Math.max(8, Math.floor(totalDuration / 80));
      for (let i = 0; i < steps; i++) {
        const progress = i / Math.max(1, steps - 1);
        const eased = 1 / (1 + Math.exp(-10 * (progress - 0.8)));
        const delay = initialDelay + eased * (maxDelay - initialDelay);
        const rnd = Math.floor(Math.random() * 10);
        await slideOnce(innerEl, rnd, delay);
      }
      const finalEl = await slideOnce(innerEl, finalNum, Math.min(maxDelay, 450));
      finalEl.classList.add('bounce');
      setTimeout(()=>finalEl.classList.remove('bounce'),500);
    }

    async function getSpinData() {
      try {
        const resp = await fetch('/spin');
        return await resp.json();
      } catch {
        return { stt: 999, hoTen: "Nguy·ªÖn Th·ªã Lan", baSoCuoi: "123" };
      }
    }

    async function spin() {
      const btn = document.getElementById('spinBtn');
      const winnerDiv = document.getElementById('winner');
      const noteDiv = document.getElementById('note');
      const innerEls = [inner1, inner2, inner3];
      const dim = document.getElementById('video-dim');
      const canvas = document.getElementById("fireworks-container");
      const ctx = canvas.getContext("2d");

      dim.style.opacity = 0;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (fireworksAnimationId) cancelAnimationFrame(fireworksAnimationId);

      ['part1','part2'].forEach(id=>{
        const el=document.getElementById(id);
        el.style.opacity=0;
        el.style.transform='translateY(20px)';
      });
      noteDiv.style.opacity=0;
      noteDiv.innerText='';

      btn.disabled=true;
      btn.innerText='üé≤ ƒêANG QUAY...';
      innerEls.forEach(e=>e.innerHTML=`<div class="digit-item">-</div>`);

      const data = await getSpinData();
      const { stt, hoTen, baSoCuoi } = data;
      const arr = baSoCuoi.split('').map(c => c || '0');
      const durations = [800, 1400, 1800];

      for(let i=0;i<arr.length;i++){
        await rollDigitSliding(innerEls[i], arr[i], durations[i]);
      }

      dim.style.opacity = 0.85;
      setTimeout(() => {
        showFireworks();
        const part1 = document.getElementById('part1');
        const part2 = document.getElementById('part2');
        part1.style.opacity = 1;
        part1.style.transform = 'translateY(0)';
        setTimeout(() => {
          part2.textContent = hoTen;
          part2.style.opacity = 1;
          part2.style.transform = 'translateY(0)';
          noteDiv.innerText = `(S·ªë th·ª© t·ª±: ${stt})`;
          noteDiv.style.opacity = 0.95;
        }, 600);
      }, 1000);

      btn.disabled=false;
      btn.innerText='QUAY L·∫†I';
    }

    document.addEventListener('keydown', e => {
      if (e.key === "Enter") {
        const btn = document.getElementById('spinBtn');
        if (!btn.disabled) btn.click();
      }
    });
  </script>
</body>
</html>